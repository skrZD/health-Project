# 🔧 食谱更新食材丢失问题解决方案

## ❌ 问题描述

当食谱内有食材数据时，修改食谱的图片并保存后，食材数据会消失。

## 🔍 问题根本原因

在 `RecipeService.updateRecipe()` 方法中，每次更新食谱时都会：

1. **删除原有明细**（第94-96行）
2. **保存新明细**（第98-105行）

但是当前端只更新图片时，没有传递食材数据，所以 `items` 参数为 `null`，导致所有食材被删除。

## ✅ 解决方案

### 修复RecipeService.java
在 `updateRecipe` 方法中添加了条件判断：

```java
// 只有当items不为null时才更新明细
if (items != null) {
    // 删除原有明细
    QueryWrapper<RecipeItem> deleteWrapper = new QueryWrapper<>();
    deleteWrapper.eq("recipe_id", recipe.getId());
    recipeItemService.remove(deleteWrapper);
    
    // 保存新明细
    if (!items.isEmpty()) {
        for (RecipeItem item : items) {
            item.setRecipeId(recipe.getId());
            item.setCreatedAt(LocalDateTime.now());
        }
        recipeItemService.saveBatch(items);
    }
}
```

### 修复逻辑说明

**修复前**：
- 无论 `items` 是否为 `null`，都会删除原有明细
- 如果 `items` 为 `null`，删除后不保存新明细，导致食材丢失

**修复后**：
- 只有当 `items` 不为 `null` 时才更新明细
- 如果 `items` 为 `null`，保留原有明细不变
- 如果 `items` 为空列表，删除所有明细（清空食材）

## 🚀 测试步骤

### 1. 重启后端服务
```bash
cd D:\JetBrains\IdeaProjects\health-platform
mvn spring-boot:run
```

### 2. 测试场景

#### 场景1：只更新图片
1. 创建一个有食材的食谱
2. 只修改图片，不修改食材
3. 保存后检查食材是否还在

#### 场景2：更新图片和食材
1. 创建一个有食材的食谱
2. 同时修改图片和食材
3. 保存后检查食材是否正确更新

#### 场景3：清空食材
1. 创建一个有食材的食谱
2. 在食材编辑界面删除所有食材
3. 保存后检查食材是否被清空

## 📋 修改内容

### 后端修改：
- **RecipeService.java** - 修复了 `updateRecipe` 方法的逻辑
- 添加了条件判断，避免意外删除食材

### 前端修改：
- 无需修改，前端逻辑保持不变

## ✅ 预期结果

- 只更新图片时，食材数据保持不变
- 更新食材时，食材数据正确更新
- 清空食材时，食材数据被正确清空

## 🔍 调试信息

如果还有问题，请检查：
1. 后端控制台是否有错误信息
2. 数据库中的 `recipe_items` 表数据是否正确
3. 前端发送的请求数据是否完整

现在请重启后端服务并测试！


